# Buoy AI Improvement Report

*Generated by 7 Claude Code agents analyzing the tool from an AI user's perspective*

---

## Executive Summary

We deployed 7 specialized agents to explore Buoy from the perspective of an AI that must use it to write design-compliant code. Each agent identified one critical gap and proposed a specific, implementable fix.

**The core insight:** Buoy is excellent at *detection* but weak at *prevention*. AI agents need context *before* they write bad code, not *after*.

---

## The 7 Improvements

| # | Area | Problem | Solution | Effort |
|---|------|---------|----------|--------|
| 1 | Context Injection | Generic rules, no real examples | Add "Learnings" section with actual drift patterns | ~40 LOC |
| 2 | Real-Time Feedback | Feedback only at commit time | PostToolUse hook for instant file-save checks | ~50 LOC |
| 3 | Error Messages | Narrative-only, not copy-paste ready | Add executable fix snippets to ai-feedback format | ~30 LOC |
| 4 | Token Discovery | No way to search tokens by value/name | `buoy tokens lookup` command with fuzzy search | ~950 LOC |
| 5 | Component Discovery | Static markdown, no query API | `ComponentQueryService` for real-time lookup | ~500 LOC |
| 6 | Learning from Mistakes | No pattern analysis across history | `buoy learn` command showing repeat mistakes | ~200 LOC |
| 7 | Setup Friction | 4-5 commands to get AI value | `buoy begin --quick-onboard` one-command setup | ~150 LOC |

---

## Improvement 1: Context Injection Quality

### Problem
The injected context at session start contains generic rules like "use design tokens" but no *actual examples* from the codebase. AI doesn't learn from real mistakes.

### Solution
Add a "Learnings" section to `generateCondensedContext()` that includes:
- Top 3 drift types found in the codebase
- Actual examples with token suggestions
- Severity indicators

### File
`/apps/cli/src/services/skill-export.ts`

### Code Change
```typescript
// After tokens section, before Guidelines:
if (data.drifts.length > 0) {
  lines.push('## What We Learned (from drift analysis)');
  lines.push('Recent issues found in the codebase:');

  const driftsByType = new Map<string, DriftSignal[]>();
  for (const drift of data.drifts) {
    const list = driftsByType.get(drift.type) || [];
    list.push(drift);
    driftsByType.set(drift.type, list);
  }

  const topDrifts = Array.from(driftsByType.entries())
    .sort((a, b) => b[1].length - a[1].length)
    .slice(0, 3);

  for (const [type, drifts] of topDrifts) {
    const critical = drifts.filter(d => d.severity === 'critical').length;
    const badge = critical > 0 ? 'üî¥' : 'üü°';
    const example = drifts[0];

    lines.push(`${badge} **${this.formatDriftType(type)}** (${drifts.length} found)`);
    lines.push(`  Example: ${example.message}`);
    if (example.details.tokenSuggestions?.length) {
      lines.push(`  Fix: ${example.details.tokenSuggestions[0]}`);
    }
  }
}
```

### Impact
Before: "Use design tokens for colors"
After: "üî¥ **Hardcoded Color** (7 found) - Example: #2563EB in Button ‚Üí use primary-color"

---

## Improvement 2: Real-Time Feedback

### Problem
AI writes bad code, saves file, continues working. Feedback only comes at commit time when context is lost.

### Solution
Add `PostToolUse` hook that runs lightweight `buoy check` on the just-modified file.

### Files
- `/apps/cli/src/hooks/index.ts` - Add PostToolUse hook generation
- `/apps/cli/src/commands/check.ts` - Add `--watch-file` and `--fast` options

### Code Change
```typescript
// In generateClaudeHooksConfig():
PostToolUse: [
  {
    matcher: "File",
    hooks: [
      {
        type: "command",
        command: "buoy check --watch-file $FILE --fast --quiet --fail-on critical"
      }
    ]
  }
]
```

### Performance
- Single file scan: ~200-500ms (cached)
- Only runs on file save, not on every keystroke
- Silent when clean, only outputs on violations

---

## Improvement 3: Actionable Error Messages

### Problem
`--format ai-feedback` outputs narrative instructions. AI needs copy-paste ready code.

### Solution
Add `fixSnippet` field with before/after code blocks.

### File
`/apps/cli/src/commands/check.ts`

### Code Change
```typescript
function generateFixSnippet(drift: DriftSignal, suggestion: string): string {
  const [file] = (drift.source.location || 'unknown').split(':');

  return `// ${file}
- ${drift.details?.actual}
+ ${suggestion}`;
}

// In formatAiFeedback():
const fix = firstSuggestion ? {
  type: "replace",
  old: drift.details?.actual,
  new: firstSuggestion,
  snippet: generateFixSnippet(drift, firstSuggestion),
  quickFix: `buoy fix --apply --type ${drift.type}`,
} : undefined;
```

### Impact
AI can now extract the exact replacement or run `quickFix` command programmatically.

---

## Improvement 4: Token Discovery

### Problem
User says "make it blue" - AI has no way to quickly find the right token.

### Solution
Create `buoy tokens lookup` command with fuzzy search by name, value, or category.

### Files
- `/packages/core/src/analysis/token-lookup.ts` (new)
- `/apps/cli/src/commands/tokens-lookup.ts` (new)

### Usage
```bash
buoy tokens lookup "primary blue"     # Fuzzy name search
buoy tokens lookup --value "#3b82f6"  # Find by color value
buoy tokens lookup --category color   # List all colors
```

### Key Features
- Levenshtein distance for fuzzy name matching
- Color similarity in RGB space (80%+ threshold)
- Spacing similarity (90%+ threshold)
- Returns confidence scores for ranking

---

## Improvement 5: Component Discovery

### Problem
User says "add a modal" - AI needs to know if Modal already exists before creating new.

### Solution
Create `ComponentQueryService` for programmatic component lookup.

### Files
- `/packages/core/src/services/component-query.ts` (new)
- `/apps/cli/src/commands/component.ts` (new)

### API
```typescript
const query = new ComponentQueryService(db, projectId);

// Check before creating
const result = await query.checkComponentExists('Modal');
// { exists: true, exact: Modal, similar: [Dialog, Drawer] }

// Find by pattern
const modals = await query.getComponentsByPattern('modal');
// [Modal, AlertDialog, ConfirmDialog, Drawer]
```

### CLI
```bash
buoy component search modal
buoy component show Modal --with-examples
buoy component check MyNewButton  # "Similar: Button (100%)"
```

---

## Improvement 6: Learning from Mistakes

### Problem
AI makes the same mistakes repeatedly. Buoy catches them but doesn't teach.

### Solution
Create `buoy learn` command that analyzes drift history to show patterns.

### File
- `/packages/core/src/graph/queries.ts` - Add `analyzeRepeatPatterns()`
- `/apps/cli/src/commands/learn.ts` (new)

### Output
```
Your Repeat Mistakes
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚óè hardcoded-color in Button (8 times)
  Files: Button.tsx, ButtonGroup.tsx
  Fix: Use color-primary token instead

‚óè hardcoded-spacing in Card (5 times)
  Files: Card.tsx
  Fix: Use spacing-md token instead

Key Insight: Your biggest issue is hardcoded-color in Button (8x)
```

### Why It Works
Groups drifts by (type + component), surfaces patterns, gives personalized recommendations.

---

## Improvement 7: Setup Friction

### Problem
Getting AI value requires 4-5 commands: `begin` ‚Üí `anchor` ‚Üí `onboard` ‚Üí `dock` ‚Üí `check`

### Solution
Add `buoy begin --quick-onboard` that chains everything in one command.

### File
`/apps/cli/src/commands/begin.ts`

### What It Does
1. Detect/create tokens
2. Scan codebase
3. Generate AI skills
4. Update CLAUDE.md
5. Show summary + next steps

### Before vs After
- Before: 10 minutes, 5 commands, decision fatigue
- After: 2 minutes, 1 command, guided flow

---

## Implementation Priority

### Phase 1: Quick Wins (This Week)
1. **Context Injection** - 40 LOC, immediate AI benefit
2. **Error Messages** - 30 LOC, makes existing output actionable
3. **Setup Friction** - 150 LOC, removes adoption barrier

### Phase 2: Core Features (Next Sprint)
4. **Real-Time Feedback** - 50 LOC, requires testing hook behavior
5. **Learning from Mistakes** - 200 LOC, uses existing graph infrastructure

### Phase 3: Advanced Discovery (Future)
6. **Token Lookup** - 950 LOC, significant new feature
7. **Component Query** - 500 LOC, requires DB optimization

---

## Success Metrics

| Improvement | Metric | Target |
|-------------|--------|--------|
| Context Injection | % of violations with prior examples | 80%+ |
| Real-Time Feedback | Time from mistake to feedback | <1s |
| Error Messages | AI fix application success rate | 90%+ |
| Token Discovery | Token lookup latency | <100ms |
| Component Discovery | False "create new" rate | <5% |
| Learning | Repeat violation rate over time | -50% |
| Setup | Commands to AI-ready | 1 |

---

## Conclusion

Buoy has solid detection infrastructure. The improvements above shift it from a *reactive* tool (catches mistakes) to a *proactive* tool (prevents mistakes).

The key insight from 7 AI agents: **We don't want to be told we failed. We want to succeed the first time.**

---

*Report generated: 2025-01-06*
*Agents: aae877f, a1a9900, aae5615, aa1f0c5, ae121a8, a5e4988, ad05486*
